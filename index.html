<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Creator Planner (Local PWA)</title>
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b0d12" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #0b0d12; color: #e8eaf0; }
    header { padding: 14px 16px; border-bottom: 1px solid #1b2130; position: sticky; top: 0; background: #0b0d12; z-index: 5; }
    h1 { margin: 0; font-size: 16px; font-weight: 650; }
    .muted { color: #a9b0c3; font-size: 12px; }
    .tabs { display:flex; gap:8px; padding: 10px 12px; border-bottom: 1px solid #1b2130; position: sticky; top: 49px; background:#0b0d12; z-index: 4;}
    .tab { padding: 8px 10px; border: 1px solid #1b2130; border-radius: 10px; background: #101522; color: #e8eaf0; cursor: pointer; font-size: 13px; }
    .tab.active { border-color: #3a4a78; background: #16203a; }
    main { padding: 12px; max-width: 1020px; margin: 0 auto; }
    .card { border: 1px solid #1b2130; background: #101522; border-radius: 14px; padding: 12px; }
    .row { display:flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    input, select, textarea, button {
      border-radius: 10px; border: 1px solid #1b2130; background: #0c1220; color: #e8eaf0;
      padding: 10px; font-size: 14px;
    }
    textarea { width: 100%; min-height: 70px; resize: vertical; }
    button { cursor: pointer; background: #16203a; border-color: #3a4a78; }
    button.secondary { background: #0c1220; border-color: #1b2130; }
    button.danger { background: #3a1620; border-color: #783a4a; }
    .pill { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid #1b2130; background: #0c1220; }
    .list { display:grid; gap: 8px; }
    .item { padding: 10px; border: 1px solid #1b2130; border-radius: 12px; background: #0c1220; }
    .hr { height: 1px; background: #1b2130; margin: 10px 0; }
    .split { display:grid; gap: 10px; grid-template-columns: 1fr; }
    @media (min-width: 860px){ .split { grid-template-columns: 1fr 1fr; } }
    .err { border-color:#783a4a; background:#2a1016; }
  
    .dow { font-size: 12px; color:#a9b0c3; padding: 6px 6px; text-align:center; border-radius:10px; border:1px solid #1b2130; background:#0c1220; }
    .daycell { min-height: 92px; padding: 8px; border-radius: 12px; border: 1px solid #1b2130; background: #0c1220; cursor: pointer; }
    .daycell.out { opacity: 0.45; }
    .daycell.today { border-color: #3a4a78; background:#101b33; }
    .daycell.selected { outline: 2px solid #3a4a78; }
    .daynum { font-weight:650; font-size: 13px; }
    .mini { margin-top:6px; display:grid; gap:4px; }
    .miniItem { font-size: 12px; color:#e8eaf0; padding: 3px 6px; border-radius: 999px; border:1px solid #1b2130; background:#0b0d12; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

  </style>
</head>
<body>
  <header>
    <h1>Creator Planner (Local)</h1>
    <div class="muted" id="subtitle"></div>
    <div id="errorBox" class="card err" style="display:none; margin-top:10px;"></div>
  </header>

  <div class="tabs">
    <button class="tab active" data-tab="calendar">Kalender</button>
    <button class="tab" data-tab="content">Content</button>
    <button class="tab" data-tab="settings">Settings</button>
  </div>

  <main>
    
    <section id="tab-calendar">
      <div class="card">
        <div class="row" style="justify-content: space-between; align-items:flex-start;">
          <div>
            <div class="muted">Kalender</div>
            <div class="muted">Monatsansicht (Grid) wie ein normaler Kalender. Tippe auf einen Tag für Details.</div>
          </div>
          <div class="row">
            <button class="secondary" id="btnPrevMonth">◀</button>
            <button class="secondary" id="btnToday">Heute</button>
            <button class="secondary" id="btnNextMonth">▶</button>
            <span class="pill" id="monthLabel"></span>
            <button class="secondary" id="btnAutoPlanAll">Auto-Plan: alle offenen Videos</button>
          </div>
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="card" style="padding:10px;">
        <div id="monthGrid" style="
          display:grid;
          grid-template-columns: repeat(7, 1fr);
          gap: 6px;
        "></div>
      </div>

      <div style="height:10px;"></div>

      <div class="card">
        <div class="muted" id="dayDetailTitle">Tag</div>
        <div class="hr"></div>
        <div id="dayDetailList" class="list"></div>
      </div>
    </section>


    <section id="tab-content" style="display:none;">
      <div class="split">
        <div class="card">
          <div class="muted">Content erstellen</div>
          <div class="row" style="margin-top:8px;">
            <select id="newType">
              <option value="Video">Video</option>
              <option value="Stream">Stream</option>
            </select>
            <input id="newTitle" placeholder="Working Title" style="flex:1; min-width: 180px;" />
          </div>
          <div class="row" style="margin-top:8px;">
            <input id="newSeries" placeholder="Game / Serie" style="flex:1; min-width: 180px;" />
            <input id="newPublish" type="datetime-local" />
          </div>
          <div class="row" style="margin-top:8px;">
            <select id="newPriority">
              <option value="1">Prio 1</option>
              <option value="2" selected>Prio 2</option>
              <option value="3">Prio 3</option>
            </select>
            <button id="btnCreate">Erstellen</button>
            <button class="secondary" id="btnCreateWeeklyPlan">Plan für diese Woche</button>
          </div>
          <div class="small muted" style="margin-top:8px;">Tipp: Wenn Publish leer ist, wird deine Standard-Zeit genutzt. Plan erstellt 1 Video + optional Stream.</div>
        </div>

        <div class="card">
          <div class="muted">Content-Liste</div>
          <div id="contentList" class="list" style="margin-top:8px;"></div>
        </div>
      </div>
    </section>

    <section id="tab-settings" style="display:none;">
      <div class="split">
        <div class="card">
          <div class="muted">Standard-Zeiten</div>
          <div class="row" style="margin-top:8px;">
            <span class="pill">Video</span>
            <select id="setPublishDay">
              <option value="0">Montag</option><option value="1">Dienstag</option><option value="2">Mittwoch</option>
              <option value="3">Donnerstag</option><option value="4">Freitag</option><option value="5">Samstag</option><option value="6">Sonntag</option>
            </select>
            <input id="setPublishTime" type="time" />
          </div>

          <div class="row" style="margin-top:10px;">
            <span class="pill">Stream</span>
            <select id="setStreamDay">
              <option value="0">Montag</option><option value="1">Dienstag</option><option value="2">Mittwoch</option>
              <option value="3">Donnerstag</option><option value="4">Freitag</option><option value="5">Samstag</option><option value="6">Sonntag</option>
            </select>
            <input id="setStreamTime" type="time" />
          </div>

          <div class="hr"></div>
          <div class="muted">Auto-Plan</div>
          <div class="row" style="margin-top:10px;">
            <span class="pill">Arbeitsstart</span>
            <input id="setWorkStartTime" type="time" />
          </div>

          <div class="hr"></div>
          <div class="muted">Schritte (Video)</div>
          <div class="row" style="margin-top:10px;">
            <label class="muted"><input type="checkbox" id="ap_outline" /> Skript/Outline</label>
            <label class="muted"><input type="checkbox" id="ap_recprep" /> Aufnahme vorbereiten</label>
            <label class="muted"><input type="checkbox" id="ap_record" /> Aufnahme</label>
          </div>
          <div class="row" style="margin-top:10px;">
            <label class="muted"><input type="checkbox" id="ap_edit_rough" /> Schnitt grob</label>
            <label class="muted"><input type="checkbox" id="ap_edit_fine" /> Schnitt fein+Audio</label>
            <label class="muted"><input type="checkbox" id="ap_thumb" /> Thumbnail</label>
          </div>
          <div class="row" style="margin-top:10px;">
            <label class="muted"><input type="checkbox" id="ap_title" /> Titel/Description</label>
            <label class="muted"><input type="checkbox" id="ap_chapters" /> Kapitelmarken</label>
            <label class="muted"><input type="checkbox" id="ap_qa" /> QA</label>
            <label class="muted"><input type="checkbox" id="ap_upload" /> Upload/Schedule</label>
          </div>

          <div class="row" style="margin-top:12px;">
            <button id="btnSaveSettings">Speichern</button>
            <button class="secondary" id="btnResetSettings">Reset</button>
          </div>
        </div>

        <div class="card">
          <div class="muted">Backup</div>
          <div class="row" style="margin-top:8px;">
            <button class="secondary" id="btnExportData">Export</button>
            <button class="secondary" id="btnImportData">Import</button>
          </div>
          <div class="small muted" style="margin-top:8px;">Export = JSON-Datei (Google Drive o.ä.). Import stellt Daten + Settings wieder her.</div>
        </div>
      </div>
    </section>
  </main>

<script>
/* ---------- Storage ---------- */
const KEY = "creator_planner_local_v1";                 // keep to preserve your data
const SETTINGS_KEY = "creator_planner_settings_v1";     // keep

function loadState(){
  const raw = localStorage.getItem(KEY);
  if(!raw){
    const init = { content: [], tasks: [] };
    localStorage.setItem(KEY, JSON.stringify(init));
    return init;
  }
  try { return JSON.parse(raw); } catch { return { content: [], tasks: [] }; }
}
function saveState(state){ localStorage.setItem(KEY, JSON.stringify(state)); }
function uid(prefix="id"){ return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now(); }

function defaultSettings(){
  return {
    publishDay: 6, publishTime: "18:00",
    streamDay: 5, streamTime: "20:00",
    workStartTime: "17:00",
    autoplan: {
      outline: false,
      recprep: true,
      record: true,
      edit_rough: true,
      edit_fine: true,
      thumb: true,
      title: true,
      chapters: true,
      qa: false,
      upload: true
    }
  };
}
function loadSettings(){
  const raw = localStorage.getItem(SETTINGS_KEY);
  if(!raw){
    const s = defaultSettings();
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
    return s;
  }
  try { return { ...defaultSettings(), ...JSON.parse(raw) }; }
  catch {
    const s = defaultSettings();
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
    return s;
  }
}
function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }

/* ---------- Dates ---------- */
function startOfWeek(d = new Date()){
  const x = new Date(d);
  const day = (x.getDay() + 6) % 7; // Mon=0
  x.setDate(x.getDate() - day);
  x.setHours(0,0,0,0);
  return x;
}
function getISOWeek(d = new Date()){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1) / 7);
  const y = date.getUTCFullYear();
  return `${y}-W${String(weekNo).padStart(2,"0")}`;
}
function toDatetimeLocalValue(dateObj){
  const d = new Date(dateObj);
  const pad = (n)=> String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function dateInWeek(baseWeekStart, dayIndexMon0, timeHHMM){
  const d = new Date(baseWeekStart);
  d.setDate(baseWeekStart.getDate() + Number(dayIndexMon0));
  const parts = String(timeHHMM || "18:00").split(":");
  const hh = parseInt(parts[0] || "18", 10);
  const mm = parseInt(parts[1] || "0", 10);
  d.setHours(hh, mm, 0, 0);
  return d;
}
function nextOccurrence(dayIndexMon0, timeHHMM){
  const now = new Date();
  const ws = startOfWeek(now);
  let target = dateInWeek(ws, dayIndexMon0, timeHHMM);
  if(target.getTime() <= now.getTime()){
    const nws = new Date(ws); nws.setDate(ws.getDate()+7);
    target = dateInWeek(nws, dayIndexMon0, timeHHMM);
  }
  return target;
}
function clampNotPast(dateObj, preferTimeHHMM){
  const now = new Date();
  if(dateObj.getTime() >= now.getTime()) return dateObj;
  const d = new Date(now);
  const parts = String(preferTimeHHMM || "17:00").split(":");
  const hh = parseInt(parts[0] || "17", 10);
  const mm = parseInt(parts[1] || "0", 10);
  d.setHours(hh, mm, 0, 0);
  if(d.getTime() <= now.getTime()) d.setTime(now.getTime() + 30*60*1000);
  return d;
}
function dayKey(dateObj){
  const d = new Date(dateObj);
  d.setHours(0,0,0,0);
  return d.toISOString();
}
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[s]));
}

/* ---------- CRUD ---------- */
function createContent({type,title,series,publish,priority}){
  const state = loadState();
  const now = new Date();
  const item = {
    id: uid("c"),
    type: type || "Video",
    title_working: title || "(ohne Titel)",
    game_or_series: series || "",
    status: "Planned",
    week: getISOWeek(now),
    publish_datetime: publish ? new Date(publish).toISOString() : "",
    priority: Number(priority || 2),
    notes: ""
  };
  state.content.unshift(item);
  saveState(state);
  return item;
}
function updateContent(id, patch){
  const state = loadState();
  const i = state.content.findIndex(x=>x.id===id);
  if(i<0) return;
  state.content[i] = {...state.content[i], ...patch};
  saveState(state);
}
function deleteContent(id){
  const state = loadState();
  state.content = state.content.filter(c=>c.id!==id);
  state.tasks = state.tasks.filter(t=>t.content_id!==id);
  saveState(state);
}
function updateTask(id, patch){
  const state = loadState();
  const i = state.tasks.findIndex(x=>x.id===id);
  if(i<0) return;
  state.tasks[i] = {...state.tasks[i], ...patch};
  saveState(state);
}

/* ---------- Auto-Plan (Video) ---------- */
function autoPlanVideoTasks(contentId){
  const state = loadState();
  const c = state.content.find(x=>x.id===contentId);
  if(!c || c.type !== "Video") return;

  const s = loadSettings();
  const ap = s.autoplan || defaultSettings().autoplan;

  // ensure publish exists and is in the future
  let publish = c.publish_datetime ? new Date(c.publish_datetime) : null;
  if(!publish || isNaN(publish.getTime())){
    publish = nextOccurrence(s.publishDay, s.publishTime);
    updateContent(contentId, { publish_datetime: publish.toISOString(), week: getISOWeek(publish) });
  }
  if(publish.getTime() <= new Date().getTime()){
    publish = nextOccurrence(s.publishDay, s.publishTime);
    updateContent(contentId, { publish_datetime: publish.toISOString(), week: getISOWeek(publish) });
  }

  const steps = [];
  if(ap.outline)  steps.push({name:"Outline / Skript", cat:"Script", dur:60, energy:"High", daysBefore:6});
  if(ap.recprep)  steps.push({name:"Aufnahme vorbereiten", cat:"Admin", dur:30, energy:"Medium", daysBefore:6});
  if(ap.record)   steps.push({name:"Aufnahme", cat:"Recording", dur:150, energy:"High", daysBefore:5});
  if(ap.edit_rough) steps.push({name:"Schnitt (Grob)", cat:"Editing", dur:120, energy:"High", daysBefore:4});
  if(ap.edit_fine)  steps.push({name:"Schnitt (Fein + Audio)", cat:"Editing", dur:120, energy:"High", daysBefore:3});
  if(ap.thumb)    steps.push({name:"Thumbnail", cat:"Thumbnail", dur:60, energy:"Medium", daysBefore:2});
  if(ap.title)    steps.push({name:"Titel/Description", cat:"Upload", dur:45, energy:"Low", daysBefore:2});
  if(ap.chapters) steps.push({name:"Kapitelmarken", cat:"Upload", dur:30, energy:"Low", daysBefore:1});
  if(ap.qa)       steps.push({name:"Final QA", cat:"Upload", dur:20, energy:"Low", daysBefore:1});
  if(ap.upload)   steps.push({name:"Upload / Schedule", cat:"Upload", dur:30, energy:"Low", daysBefore:1});

  // Remove old auto tasks with same names (replan)
  const names = new Set(steps.map(x=>x.name));
  state.tasks = state.tasks.filter(t => !(t.content_id===contentId && names.has(t.task_name)));

  const workStart = s.workStartTime || "17:00";
  const perDayCursor = {};
  let orderBase = state.tasks.filter(t=>t.content_id===contentId).length;

  for(const step of steps){
    let due = new Date(publish.getTime() - step.daysBefore*24*60*60*1000);
    const key = dayKey(due);

    // place time cursor
    if(!perDayCursor[key]){
      const parts = String(workStart).split(":");
      const hh = parseInt(parts[0] || "17", 10);
      const mm = parseInt(parts[1] || "0", 10);
      due.setHours(hh, mm, 0, 0);
    } else {
      due = new Date(perDayCursor[key]);
    }

    due = clampNotPast(due, workStart);

    // advance cursor by duration + 15 min buffer
    perDayCursor[key] = new Date(due.getTime() + (step.dur + 15)*60*1000).toISOString();

    state.tasks.push({
      id: uid("t"),
      content_id: contentId,
      task_name: step.name,
      category: step.cat,
      status: "To Do",
      due_date: due.toISOString(),
      duration_min: step.dur,
      energy: step.energy,
      order: ++orderBase
    });
  }

  saveState(state);
}

/* ---------- Calendar render ---------- */

let __calMonth = new Date();  // current visible month
let __selectedDay = null;

function startOfMonth(d){
  const x = new Date(d);
  x.setDate(1); x.setHours(0,0,0,0);
  return x;
}
function addMonths(d, delta){
  const x = new Date(d);
  x.setMonth(x.getMonth() + delta, 1);
  x.setHours(0,0,0,0);
  return x;
}
function sameDay(a,b){
  return a && b && a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}
function monthLabel(d){
  return d.toLocaleDateString(undefined, { month:"long", year:"numeric" });
}
function toYMD(d){
  const x = new Date(d); x.setHours(0,0,0,0);
  return x.toISOString().slice(0,10);
}

function itemsForDay(state, dayStart){
  const dayEnd = new Date(dayStart); dayEnd.setDate(dayStart.getDate()+1);

  const pubs = state.content
    .filter(c=>c.publish_datetime)
    .filter(c=>{
      const dt = new Date(c.publish_datetime);
      return dt >= dayStart && dt < dayEnd;
    })
    .map(c=>({ kind:"publish", title:`${c.type}: ${c.title_working}`, contentId:c.id, time: new Date(c.publish_datetime) }));

  const tasks = state.tasks
    .filter(t=>t.due_date)
    .filter(t=>{
      const dt = new Date(t.due_date);
      return dt >= dayStart && dt < dayEnd;
    })
    .sort((a,b)=> new Date(a.due_date) - new Date(b.due_date))
    .map(t=>({ kind:"task", title:t.task_name, taskId:t.id, contentId:t.content_id, time: new Date(t.due_date), done: t.status==="Done" }));

  return { pubs, tasks };
}

function renderDayDetails(day){
  const state = loadState();
  const title = document.getElementById("dayDetailTitle");
  const list = document.getElementById("dayDetailList");
  const d = new Date(day); d.setHours(0,0,0,0);
  title.textContent = d.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"2-digit", day:"2-digit" });
  list.innerHTML = "";

  const { pubs, tasks } = itemsForDay(state, d);

  if(!pubs.length && !tasks.length){
    list.innerHTML = '<div class="muted">—</div>';
    return;
  }

  if(pubs.length){
    const box = document.createElement("div");
    box.className = "item";
    box.innerHTML = `<div style="font-weight:650">Veröffentlichungen</div><div class="hr"></div>` +
      pubs.map(p=>`<div class="row" style="justify-content:space-between;">
        <div>${escapeHtml(p.title)}</div>
        <div class="muted">${p.time.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}</div>
      </div>`).join("");
    list.appendChild(box);
  }

  if(tasks.length){
    const box = document.createElement("div");
    box.className = "item";
    box.innerHTML = `<div style="font-weight:650">Tasks</div><div class="hr"></div>`;
    for(const t of tasks){
      const c = state.content.find(x=>x.id===t.contentId);
      const row = document.createElement("div");
      row.className = "row";
      row.style.justifyContent = "space-between";
      row.style.alignItems = "center";
      row.innerHTML = `
        <div style="min-width:220px;">
          <div style="font-weight:650">${escapeHtml(t.title)} ${t.done ? '<span class="pill">✓</span>' : ''}</div>
          <div class="muted">${t.time.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})} ${c ? "• " + escapeHtml(c.title_working) : ""}</div>
        </div>
        <div class="row">
          <label class="muted"><input type="checkbox" ${t.done ? "checked" : ""} onchange="updateTask('${t.taskId}', {status: this.checked ? 'Done' : 'To Do'}); render();" /> Fertig</label>
        </div>`;
      box.appendChild(row);
    }
    list.appendChild(box);
  }
}

function renderMonthGrid(){
  const state = loadState();
  const grid = document.getElementById("monthGrid");
  const label = document.getElementById("monthLabel");
  if(label) label.textContent = monthLabel(__calMonth);

  grid.innerHTML = "";
  const dows = ["Mo","Di","Mi","Do","Fr","Sa","So"];
  for(const w of dows){
    const el = document.createElement("div");
    el.className = "dow";
    el.textContent = w;
    grid.appendChild(el);
  }

  const monthStart = startOfMonth(__calMonth);
  const ws = startOfWeek(monthStart); // Monday before month start
  const today = new Date(); today.setHours(0,0,0,0);

  // 6 weeks grid
  for(let i=0;i<42;i++){
    const day = new Date(ws); day.setDate(ws.getDate()+i);
    const inMonth = day.getMonth() === monthStart.getMonth();
    const cell = document.createElement("div");
    cell.className = "daycell" + (inMonth ? "" : " out") + (sameDay(day,today) ? " today" : "") + (sameDay(day,__selectedDay) ? " selected" : "");

    const { pubs, tasks } = itemsForDay(state, day);
    const doneCount = tasks.filter(t=>t.done).length;

    cell.innerHTML = `
      <div class="row" style="justify-content: space-between; align-items:baseline;">
        <div class="daynum">${day.getDate()}</div>
        <div class="muted" style="font-size:11px;">${tasks.length ? (doneCount + "/" + tasks.length) : ""}</div>
      </div>
      <div class="mini">
        ${pubs.slice(0,1).map(p=>`<div class="miniItem">${escapeHtml(p.title)}</div>`).join("")}
        ${tasks.slice(0,2).map(t=>`<div class="miniItem">${t.done ? "✓ " : ""}${escapeHtml(t.title)}</div>`).join("")}
        ${(pubs.length + tasks.length) > 3 ? `<div class="muted" style="font-size:11px;">+${(pubs.length+tasks.length)-3} mehr</div>` : ``}
      </div>
    `;

    cell.addEventListener("click", ()=>{
      __selectedDay = new Date(day);
      __selectedDay.setHours(0,0,0,0);
      renderMonthGrid();
      renderDayDetails(__selectedDay);
    });

    grid.appendChild(cell);
  }

  // default selection
  if(!__selectedDay){
    __selectedDay = today;
    renderDayDetails(today);
  }
}

function renderCalendar(){
  renderMonthGrid();
}

/* ---------- UI render ---------- */
function renderContentList(){
  const box = document.getElementById("contentList");
  const state = loadState();
  box.innerHTML = "";
  if(!state.content.length){
    box.innerHTML = '<div class="muted">Noch kein Content vorhanden.</div>';
    return;
  }
  for(const c of state.content){
    const tasks = state.tasks.filter(t=>t.content_id===c.id);
    const done = tasks.filter(t=>t.status==="Done").length;
    const total = tasks.length;
    const card = document.createElement("div");
    card.className = "item";
    card.innerHTML = `
      <div class="row" style="justify-content: space-between;">
        <div>
          <div style="font-weight:650">${escapeHtml(c.title_working)} <span class="pill">${c.type}</span></div>
          <div class="muted">${escapeHtml(c.game_or_series||"")} • Publish: ${c.publish_datetime ? new Date(c.publish_datetime).toLocaleString() : "—"}</div>
          <div class="muted">Tasks: ${done}/${total}</div>
        </div>
        <div class="row">
          ${c.type==="Video" ? `<button class="secondary" onclick="autoPlanVideoTasks('${c.id}'); render();">Auto-Plan</button>` : ``}
          <button class="danger" onclick="if(confirm('Content wirklich löschen?')){ deleteContent('${c.id}'); render(); }">✕</button>
        </div>
      </div>
    `;
    box.appendChild(card);
  }
}

function renderSettingsUI(){
  const s = loadSettings();
  document.getElementById("setPublishDay").value = String(s.publishDay);
  document.getElementById("setPublishTime").value = s.publishTime;
  document.getElementById("setStreamDay").value = String(s.streamDay);
  document.getElementById("setStreamTime").value = s.streamTime;
  document.getElementById("setWorkStartTime").value = s.workStartTime || "17:00";

  const ap = s.autoplan || defaultSettings().autoplan;
  document.getElementById("ap_outline").checked = !!ap.outline;
  document.getElementById("ap_recprep").checked = ap.recprep !== false;
  document.getElementById("ap_record").checked = ap.record !== false;
  document.getElementById("ap_edit_rough").checked = ap.edit_rough !== false;
  document.getElementById("ap_edit_fine").checked = ap.edit_fine !== false;
  document.getElementById("ap_thumb").checked = ap.thumb !== false;
  document.getElementById("ap_title").checked = ap.title !== false;
  document.getElementById("ap_chapters").checked = ap.chapters !== false;
  document.getElementById("ap_qa").checked = !!ap.qa;
  document.getElementById("ap_upload").checked = ap.upload !== false;
}

function render(){
  const now = new Date();
  document.getElementById("subtitle").textContent = `Woche: ${getISOWeek(now)} • Lokal gespeichert`;
  renderContentList();
  renderCalendar();
}

/* ---------- Events ---------- */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const tab = btn.dataset.tab;
    document.getElementById("tab-calendar").style.display = (tab==="calendar") ? "" : "none";
    document.getElementById("tab-content").style.display  = (tab==="content")  ? "" : "none";
    document.getElementById("tab-settings").style.display = (tab==="settings") ? "" : "none";
    renderSettingsUI();
    render();
  });
});


document.getElementById("btnAutoPlanAll").addEventListener("click", ()=>{
  const state = loadState();
  const vids = state.content.filter(c=>c.type==="Video" && c.status!=="Published");
  for(const v of vids) autoPlanVideoTasks(v.id);
  alert("Auto-Plan fertig.");
  render();
});


document.getElementById("btnPrevMonth").addEventListener("click", ()=>{
  __calMonth = addMonths(__calMonth, -1);
  render();
});
document.getElementById("btnNextMonth").addEventListener("click", ()=>{
  __calMonth = addMonths(__calMonth, +1);
  render();
});
document.getElementById("btnToday").addEventListener("click", ()=>{
  __calMonth = new Date();
  __selectedDay = new Date(); __selectedDay.setHours(0,0,0,0);
  render();
});
document.getElementById("btnCreate").addEventListener("click", ()=>{
  const s = loadSettings();
  const type = document.getElementById("newType").value;
  const title = document.getElementById("newTitle").value.trim();
  const series = document.getElementById("newSeries").value.trim();
  let publishVal = document.getElementById("newPublish").value;

  if(!publishVal){
    if(type==="Video") publishVal = toDatetimeLocalValue(nextOccurrence(s.publishDay, s.publishTime));
    else publishVal = toDatetimeLocalValue(nextOccurrence(s.streamDay, s.streamTime));
  }

  const item = createContent({type, title, series, publish: publishVal, priority: document.getElementById("newPriority").value});
  document.getElementById("newTitle").value = "";
  document.getElementById("newPublish").value = "";

  if(item.type==="Video"){
    if(confirm("Auto-Plan für dieses Video erstellen?")) autoPlanVideoTasks(item.id);
  }
  render();
});

document.getElementById("btnCreateWeeklyPlan").addEventListener("click", ()=>{
  const s = loadSettings();
  const pub = nextOccurrence(s.publishDay, s.publishTime);
  const video = createContent({type:"Video", title:"Video der Woche", series:"", publish: toDatetimeLocalValue(pub), priority: 1});
  autoPlanVideoTasks(video.id);

  const addStream = confirm("Auch einen Stream für diese Woche erstellen?");
  if(addStream){
    const st = nextOccurrence(s.streamDay, s.streamTime);
    createContent({type:"Stream", title:"Stream der Woche", series:"", publish: toDatetimeLocalValue(st), priority: 2});
  }
  alert("Plan erstellt.");
  render();
});

document.getElementById("btnSaveSettings").addEventListener("click", ()=>{
  const s = loadSettings();
  s.publishDay = Number(document.getElementById("setPublishDay").value);
  s.publishTime = document.getElementById("setPublishTime").value || s.publishTime;
  s.streamDay = Number(document.getElementById("setStreamDay").value);
  s.streamTime = document.getElementById("setStreamTime").value || s.streamTime;
  s.workStartTime = document.getElementById("setWorkStartTime").value || s.workStartTime;

  s.autoplan = {
    outline: document.getElementById("ap_outline").checked,
    recprep: document.getElementById("ap_recprep").checked,
    record: document.getElementById("ap_record").checked,
    edit_rough: document.getElementById("ap_edit_rough").checked,
    edit_fine: document.getElementById("ap_edit_fine").checked,
    thumb: document.getElementById("ap_thumb").checked,
    title: document.getElementById("ap_title").checked,
    chapters: document.getElementById("ap_chapters").checked,
    qa: document.getElementById("ap_qa").checked,
    upload: document.getElementById("ap_upload").checked,
  };

  saveSettings(s);
  alert("Gespeichert.");
  renderSettingsUI();
  render();
});

document.getElementById("btnResetSettings").addEventListener("click", ()=>{
  saveSettings(defaultSettings());
  alert("Zurückgesetzt.");
  renderSettingsUI();
  render();
});

/* Backup */
function downloadTextFile(filename, text){
  const blob = new Blob([text], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
document.getElementById("btnExportData").addEventListener("click", ()=>{
  const payload = {
    version: "v1.6",
    exported_at: new Date().toISOString(),
    settings: loadSettings(),
    data: loadState()
  };
  downloadTextFile("creator_planner_backup.json", JSON.stringify(payload, null, 2));
});
document.getElementById("btnImportData").addEventListener("click", ()=>{
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";
  input.onchange = () => {
    const file = input.files && input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const obj = JSON.parse(String(reader.result || ""));
        if(obj.settings) saveSettings(obj.settings);
        if(obj.data) saveState(obj.data);
        alert("Import fertig.");
        renderSettingsUI();
        render();
      } catch {
        alert("Import fehlgeschlagen: ungültige JSON-Datei.");
      }
    };
    reader.readAsText(file);
  };
  input.click();
});

/* Error capture (shows if anything breaks) */
window.addEventListener("error", (e)=>{
  const box = document.getElementById("errorBox");
  box.style.display = "";
  box.innerHTML = `<div style="font-weight:650">Fehler in der App</div>
    <div class="muted">Wenn du mir das hier kopierst, kann ich es sofort fixen.</div>
    <div class="hr"></div>
    <pre style="white-space:pre-wrap; font-size:12px; margin:0;">${escapeHtml(String(e.message || e))}</pre>`;
});
window.addEventListener("unhandledrejection", (e)=>{
  const box = document.getElementById("errorBox");
  box.style.display = "";
  box.innerHTML = `<div style="font-weight:650">Fehler (Promise)</div>
    <div class="muted">Wenn du mir das hier kopierst, kann ich es sofort fixen.</div>
    <div class="hr"></div>
    <pre style="white-space:pre-wrap; font-size:12px; margin:0;">${escapeHtml(String(e.reason || e))}</pre>`;
});

/* Init */
renderSettingsUI();
render();

// --- PWA: service worker registration ---
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(() => {});
  });
}
</script>
</body>
</html>
